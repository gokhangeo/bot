<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Kadastro YÃ¶netim</title>
    
    <!-- Leaflet Harita -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Excel Okuyucu -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Ä°konlar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #f4f6f9; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* --- SOL KONTROL PANELÄ° --- */
        #control-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000; width: 360px;
            border-left: 5px solid #2c3e50;
            transition: all 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        #control-panel.minimized {
            width: 50px; height: 50px; padding: 0; overflow: hidden;
            border-left: none; border-radius: 50%;
            background: #2c3e50; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #control-panel.minimized * { display: none; }
        #control-panel.minimized::after {
            content: '\f0c9'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; font-size: 20px; display: block;
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; color: #2c3e50; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .btn-minimize { background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 14px; }
        .btn-minimize:hover { color: #2c3e50; }

        /* Filtre ButonlarÄ± */
        .filter-bar { display: flex; gap: 3px; margin-bottom: 15px; background: #ecf0f1; padding: 4px; border-radius: 8px; }
        .filter-btn {
            flex: 1; padding: 8px 0; cursor: pointer;
            border-radius: 6px; font-size: 11px; font-weight: 700;
            text-align: center; color: #7f8c8d; transition: all 0.2s;
        }
        .filter-btn.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Ä°statistik Grid */
        .dashboard-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .dash-stat { background: #f8f9fa; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #eee; }
        .d-val { font-size: 13px; font-weight: 800; color: #2c3e50; display: block; }
        .d-lbl { font-size: 9px; color: #7f8c8d; text-transform: uppercase; }

        /* Form ElemanlarÄ± */
        label { font-size: 11px; font-weight: 600; color: #34495e; display: block; margin-bottom: 4px; margin-top: 10px;}
        select { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; cursor: pointer; background: #fff; }
        select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 2px rgba(52,152,219,0.1); }

        /* Bilgi KartÄ± */
        #info-card {
            background: linear-gradient(to bottom right, #ffffff, #fdfdfd);
            border: 1px solid #e1e4e8; border-radius: 10px;
            padding: 15px; margin-top: 15px; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .card-title { font-size: 15px; font-weight: 800; color: #2c3e50; }
        .card-badge { font-size: 10px; padding: 3px 8px; border-radius: 12px; color: white; font-weight: bold; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .info-box { background: #f1f2f6; padding: 10px; border-radius: 6px; text-align: center; }
        .ib-val { font-size: 16px; font-weight: 800; color: #2c3e50; display: block; }
        .ib-lbl { font-size: 10px; color: #7f8c8d; }

        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn { flex: 1; border: none; padding: 10px; border-radius: 6px; color: white; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-tkgm { background: #27ae60; }
        .btn-nav { background: #2980b9; }
        .btn-reset { width: 100%; background: #95a5a6; margin-top: 15px; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;}

        /* --- ALT TABLO PANELÄ° --- */
        #bottom-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 40px; /* KapalÄ± yÃ¼kseklik */
            background: white; z-index: 1000;
            border-top: 1px solid #ddd;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            transition: height 0.3s ease;
            display: flex; flex-direction: column;
        }
        #bottom-panel.expanded { height: 400px; }

        .bp-header {
            padding: 0 20px; height: 40px;
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .bp-title { font-weight: 700; color: #2c3e50; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .bp-toggle-icon { transition: transform 0.3s; }
        #bottom-panel.expanded .bp-toggle-icon { transform: rotate(180deg); }

        .table-container { flex: 1; overflow: auto; display: none; padding: 10px; }
        #bottom-panel.expanded .table-container { display: block; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f2f6; font-weight: 700; color: #2c3e50; position: sticky; top: 0; }
        tr:hover { background: #f9f9f9; cursor: pointer; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* Loader */
        #loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <div style="font-weight:800; color:#2c3e50; font-size:18px;">SÄ°STEM BAÅžLATILIYOR</div>
        <div style="font-size:13px; color:#7f8c8d; margin-top:5px">Veriler GitHub Ãœzerinden Ã‡ekiliyor...</div>
    </div>

    <!-- SOL PANEL -->
    <div id="control-panel">
        <div class="panel-header">
            <h2><i class="fa-solid fa-map-location-dot"></i> KADASTRO YÃ–NETÄ°M</h2>
            <button class="btn-minimize" onclick="togglePanel()"><i class="fa-solid fa-minus"></i></button>
        </div>

        <!-- DASHBOARD -->
        <div class="dashboard-stats">
            <div class="dash-stat">
                <span class="d-val" id="dashTotal">0</span>
                <span class="d-lbl">Toplam Ä°ÅŸ</span>
            </div>
            <div class="dash-stat">
                <span class="d-val" id="dashParsel">0</span>
                <span class="d-lbl">Toplam Parsel</span>
            </div>
            <div class="dash-stat">
                <span class="d-val" id="dashAlan">0</span>
                <span class="d-lbl">Toplam Ha</span>
            </div>
        </div>
        
        <!-- ANA FÄ°LTRE -->
        <div class="filter-bar">
            <div class="filter-btn active" onclick="setMainFilter('all', this)">TÃœMÃœ</div>
            <div class="filter-btn" onclick="setMainFilter('ihalede', this)">Ä°HALE (2026)</div>
            <div class="filter-btn" onclick="setMainFilter('devam', this)">DEVAM EDEN</div>
        </div>

        <!-- ALT FÄ°LTRELER -->
        <label><i class="fa-solid fa-briefcase"></i> Ä°ÅŸ TÃ¼rÃ¼</label>
        <select id="jobTypeSelect" onchange="applyFilters()">
            <option value="all">TÃ¼m Ä°ÅŸler</option>
            <option value="2b">2/B Ã‡alÄ±ÅŸmalarÄ±</option>
            <option value="guncelleme">GÃ¼ncelleme</option>
            <option value="mudurluk">DiÄŸer (Tesis/7139)</option>
        </select>

        <label><i class="fa-solid fa-city"></i> Ä°lÃ§e Filtrele</label>
        <select id="districtSelect" onchange="applyFilters()">
            <option value="all">Veriler YÃ¼kleniyor...</option>
        </select>

        <label><i class="fa-solid fa-tree-city"></i> Birim SeÃ§imi</label>
        <select id="neighborhoodSelect" onchange="zoomToLocation()" disabled>
            <option value="">Ã–nce Listeden SeÃ§iniz</option>
        </select>

        <!-- BÄ°LGÄ° KARTI -->
        <div id="info-card">
            <div class="card-title-row">
                <span class="card-title" id="infoTitle"></span>
                <span class="card-badge" id="infoBadge"></span>
            </div>
            
            <div id="infoStatus" style="font-size:11px; text-align:center; margin-bottom:10px; color:#7f8c8d;"></div>

            <div class="info-grid" id="infoStats">
                <!-- JS ile dolacak -->
            </div>

            <div class="btn-group">
                <button class="btn btn-tkgm" onclick="openTKGM()"><i class="fa-solid fa-building-columns"></i> TKGM</button>
                <button class="btn btn-nav" onclick="openNav()"><i class="fa-solid fa-location-arrow"></i> Rota</button>
            </div>
        </div>

        <button class="btn-reset" onclick="resetView()">GÃ¶rÃ¼nÃ¼mÃ¼ SÄ±fÄ±rla</button>
    </div>

    <!-- HARÄ°TA -->
    <div id="map"></div>

    <!-- ALT TABLO PANELÄ° -->
    <div id="bottom-panel">
        <div class="bp-header" onclick="toggleBottomPanel()">
            <div class="bp-title">
                <i class="fa-solid fa-table-list"></i> DETAYLI Ä°Åž LÄ°STESÄ°
                <span style="font-size:11px; font-weight:normal; color:#7f8c8d; margin-left:10px;" id="tableCount">(0 KayÄ±t)</span>
            </div>
            <div class="bp-toggle-icon"><i class="fa-solid fa-chevron-up"></i></div>
        </div>
        <div class="table-container">
            <input type="text" id="tableSearch" placeholder="Tabloda Ara (Mahalle, Ä°lÃ§e, Ä°ÅŸ TÃ¼rÃ¼...)" onkeyup="searchTable()" 
                   style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Durum</th>
                        <th>Ä°lÃ§e</th>
                        <th>Birim</th>
                        <th>Ä°ÅŸ TÃ¼rÃ¼</th>
                        <th>Parsel/Blok</th>
                        <th>Alan (Ha)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- JS ile dolacak -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- GITHUB CONFIG ---
        const p1 = "ghp_4NLVwVbi"; const p2 = "UOp1nerCIiZr"; const p3 = "c4cGlRa5MF2yhJwX";
        const GITHUB_TOKEN = p1 + p2 + p3;
        const API_URL = `https://api.github.com/repos/gokhangeo/guncelleme/contents/kadastro_veri.xlsx`;

        // --- KOORDÄ°NATLAR ---
        const COORDINATE_DB = {
             "ANAMUR_AÅžAÄžIKÃœKÃœR": [36.197, 32.775], "ANAMUR_BOZDOÄžAN": [36.132, 32.910], 
             "ANAMUR_Ã‡UKURABANOZ": [36.225, 32.784], "GÃœLNAR_BÃœYÃœKECELÄ°": [36.169, 33.556],
             "SÄ°LÄ°FKE_ARKUM": [36.350, 34.057], "SÄ°LÄ°FKE_TAÅžUCU": [36.320, 33.880]
        };
        const DISTRICT_CENTERS = {
            "ANAMUR": [36.075, 32.835], "BOZYAZI": [36.096, 32.960], "GÃœLNAR": [36.343, 33.403],
            "SÄ°LÄ°FKE": [36.377, 33.934], "MUT": [36.643, 33.435], "ERDEMLÄ°": [36.603, 34.306],
            "TARSUS": [36.915, 34.895], "AKDENÄ°Z": [36.812, 34.640], "MEZÄ°TLÄ°": [36.752, 34.556],
            "TOROSLAR": [36.820, 34.600], "YENÄ°ÅžEHÄ°R": [36.779, 34.587], "Ã‡AMLIYAYLA": [37.165, 34.603]
        };

        // --- APP STATE ---
        const map = L.map('map', { zoomControl: false }).setView([36.7, 34.0], 9);
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 21, subdomains:['mt0','mt1','mt2','mt3'], attribution:'Â© Google Data'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        let allData = []; 
        let markers = [];
        let currentMainFilter = 'all'; 
        let currentSubFilter = 'all';  
        let currentMarker = null; 

        const styles = {
            "ihalede": { color: "#e74c3c", label: "2026 Plan" },
            "2b": { color: "#e67e22", label: "2/B Ä°ÅŸleri" },
            "guncelleme": { color: "#3498db", label: "GÃ¼ncelleme" },
            "mudurluk": { color: "#9b59b6", label: "Tesis/7139" }
        };

        function normalizeText(text) {
            if(!text) return "";
            return String(text).toLocaleUpperCase('tr-TR').trim();
        }

        // --- DATA FETCH ---
        async function fetchData() {
            try {
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) throw new Error("GitHub BaÄŸlantÄ± HatasÄ±");
                
                const data = await response.json();
                const binaryString = window.atob(data.content.replace(/\s/g, ''));
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

                const workbook = XLSX.read(bytes.buffer, { type: 'array' });

                workbook.SheetNames.forEach(sheetName => {
                     let context = "Devam"; 
                     if(sheetName.toLocaleUpperCase('tr-TR').includes("Ä°HALE") || sheetName.toUpperCase().includes("IHALE")) {
                         context = "Ihale";
                     }
                     const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                     processExcelData(json, context);
                });

                document.getElementById("loading-overlay").style.display = "none";
                populateFilterOptions(); // Ä°lÃ§eleri doldur
                applyFilters(); // Ä°lk aÃ§Ä±lÄ±ÅŸta her ÅŸeyi gÃ¶ster

            } catch (error) {
                console.error(error);
                document.getElementById("loading-overlay").innerHTML = `<div style='color:red; text-align:center;'>Hata OluÅŸtu:<br>${error.message}</div>`;
            }
        }

        function processExcelData(jsonData, originContext) {
            jsonData.forEach(row => {
                const getVal = (keys) => {
                    for (let k of keys) {
                        if (row[k] !== undefined) return row[k];
                        let foundKey = Object.keys(row).find(rk => normalizeText(rk) === normalizeText(k));
                        if(foundKey) return row[foundKey];
                    }
                    return "";
                };

                let ilce = normalizeText(getVal(["Ä°LÃ‡E", "Ä°lÃ§e"]));
                let birim = normalizeText(getVal(["BÄ°RÄ°M", "Birim"]));
                let uygulama = getVal(["UYGULAMA"]);
                
                let parsel = getVal(["PARSEL SAYISI", "Parsel", "PARSEL"]) || 0;
                let blok = getVal(["BLOK SAYISI", "Blok", "BLOK"]) || 0;
                let alan = getVal(["ALAN(Ha)", "Alan", "ALAN"]) || 0;
                let durum = getVal(["Ä°HALELÄ°/MÃœDÃœRLÃœK"]) || (originContext === "Ihale" ? "Ä°haleli (2026)" : "Bilinmiyor");

                if (!ilce || !birim) return;

                let category = "mudurluk";
                let appLower = String(uygulama).toLocaleLowerCase('tr-TR');
                let is2B = appLower.includes("2/b") || appLower.includes("2b");

                if (originContext === "Ihale") {
                    category = "ihalede";
                } else {
                    if (is2B) category = "2b";
                    else if (appLower.includes("gÃ¼ncelleme")) category = "guncelleme";
                    else if (appLower.includes("7139") || appLower.includes("tesis")) category = "mudurluk";
                    
                    if(String(durum).toLocaleLowerCase('tr-TR').includes("ihaleli") && appLower.includes("gÃ¼ncelleme")) category = "guncelleme";
                }

                if (!is2B && parsel == 0 && blok > 0) { parsel = blok; blok = 0; }
                if (originContext === "Ihale" && parsel == 0 && blok > 0) { parsel = blok; blok = 0; }

                let lat, lon;
                let key = `${ilce}_${birim}`;
                let coords = COORDINATE_DB[key];
                if (coords) { lat = coords[0]; lon = coords[1]; }

                allData.push({
                    id: key + "_" + Math.random(),
                    dist: ilce,
                    name: birim,
                    cat: category, 
                    app: uygulama,
                    p: parsel,
                    blk: blok,
                    ha: alan,
                    status: durum,
                    is2B: is2B, 
                    lat: lat,
                    lon: lon
                });
            });
        }

        // --- FÄ°LTRE YÃ–NETÄ°MÄ° ---
        
        // Sadece baÅŸlangÄ±Ã§ta ilÃ§eleri doldurmak iÃ§in
        function populateFilterOptions() {
            const dists = [...new Set(allData.map(d => d.dist))].sort();
            const dSelect = document.getElementById("districtSelect");
            dSelect.innerHTML = `<option value="all">TÃ¼m Ä°lÃ§eler (${dists.length})</option>`;
            dists.forEach(d => dSelect.innerHTML += `<option value="${d}">${d}</option>`);
        }

        function setMainFilter(filterType, btn) {
            currentMainFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        // Ana Filtreleme Fonksiyonu
        // Hem dropdown'larÄ±, hem tabloyu, hem haritayÄ± etkiler
        function applyFilters() {
            const selectedJob = document.getElementById("jobTypeSelect").value;
            const selectedDist = document.getElementById("districtSelect").value;

            // 1. Veri SÃ¼zme
            const filteredData = allData.filter(d => {
                // Ana Filtre (TÃ¼mÃ¼/Ä°hale/Devam)
                let mainPass = false;
                if (currentMainFilter === 'all') mainPass = true;
                else if (currentMainFilter === 'ihalede' && d.cat === 'ihalede') mainPass = true;
                else if (currentMainFilter === 'devam' && d.cat !== 'ihalede') mainPass = true;
                if (!mainPass) return false;

                // Ä°ÅŸ TÃ¼rÃ¼ Filtresi
                let jobPass = false;
                if (selectedJob === 'all') jobPass = true;
                else if (selectedJob === d.cat) jobPass = true;
                if (!jobPass) return false;

                // Ä°lÃ§e Filtresi
                if (selectedDist !== 'all' && d.dist !== selectedDist) return false;

                return true;
            });

            // 2. ArayÃ¼z GÃ¼ncelleme
            renderMarkers(filteredData);
            renderTable(filteredData);
            updateDashboard(filteredData);
            updateNeighborhoodDropdown(filteredData);
            
            // HaritayÄ± sÄ±ÄŸdÄ±r (EÄŸer ilÃ§e seÃ§iliyse)
            if (selectedDist !== 'all') {
                 // Marker varsa sÄ±nÄ±rlara git, yoksa ilÃ§e merkezine
                 if (markers.length > 0) {
                     const group = new L.featureGroup(markers);
                     map.fitBounds(group.getBounds(), {padding:[50,50]});
                 } else {
                     const center = DISTRICT_CENTERS[selectedDist];
                     if(center) map.flyTo(center, 11);
                 }
            }
        }

        function updateDashboard(data) {
            let tParsel = 0, tAlan = 0;
            data.forEach(d => {
                tParsel += parseInt(d.p || 0) + parseInt(d.blk || 0);
                tAlan += parseFloat(d.ha || 0);
            });
            document.getElementById("dashTotal").innerText = data.length;
            document.getElementById("dashParsel").innerText = tParsel.toLocaleString();
            document.getElementById("dashAlan").innerText = tAlan.toFixed(1);
        }

        function updateNeighborhoodDropdown(data) {
            const nSelect = document.getElementById("neighborhoodSelect");
            nSelect.disabled = false;
            nSelect.innerHTML = '<option value="">Birim SeÃ§iniz</option>';
            
            data.sort((a,b) => a.name.localeCompare(b.name));
            data.forEach(u => {
                const val = encodeURIComponent(JSON.stringify(u));
                let info = u.is2B ? `${u.blk} Blok` : `${u.p} Parsel`;
                nSelect.innerHTML += `<option value="${val}">${u.name} (${info})</option>`;
            });
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if(currentMarker) map.removeLayer(currentMarker);

            data.forEach(d => {
                if(d.lat && d.lon) {
                    const style = styles[d.cat] || styles["mudurluk"];
                    const marker = L.circleMarker([d.lat, d.lon], {
                        color: "#fff", weight: 1, fillColor: style.color, fillOpacity: 0.9, radius: 6
                    }).addTo(map);
                    
                    marker.bindTooltip(`${d.name}`, {permanent: false, direction: 'top'});
                    marker.on('click', () => {
                        selectUnit(d);
                        if(document.getElementById("control-panel").classList.contains("minimized")) togglePanel();
                    });
                    markers.push(marker);
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            document.getElementById("tableCount").innerText = `(${data.length} KayÄ±t)`;

            data.forEach(d => {
                const style = styles[d.cat] || styles["mudurluk"];
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><span class="status-dot" style="background:${style.color}"></span>${style.label}</td>
                    <td>${d.dist}</td>
                    <td><strong>${d.name}</strong></td>
                    <td>${d.app || '-'}</td>
                    <td>${d.is2B ? d.blk : d.p}</td>
                    <td>${d.ha || '-'}</td>
                `;
                tr.onclick = () => {
                    selectUnit(d);
                    if(d.lat) map.flyTo([d.lat, d.lon], 16, {duration: 1.5});
                    else fetchAndZoom(d);
                };
                tbody.appendChild(tr);
            });
        }

        function searchTable() {
            const input = document.getElementById("tableSearch");
            const filter = normalizeText(input.value);
            const tr = document.getElementById("tableBody").getElementsByTagName("tr");

            for (let i = 0; i < tr.length; i++) {
                const txtValue = tr[i].textContent || tr[i].innerText;
                if (normalizeText(txtValue).indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        // --- MAP & ACTION ---
        async function fetchAndZoom(d) {
            const onlineCoords = await fetchCoordinatesOnline(d.dist, d.name);
            if(onlineCoords) {
                d.lat = onlineCoords.lat;
                d.lon = onlineCoords.lon;
                selectUnit(d);
                map.flyTo([d.lat, d.lon], 16, {duration: 1.5});
            } else {
                alert("Konum BulunamadÄ±. Ä°lÃ§e Merkezine Gidiliyor.");
                let center = DISTRICT_CENTERS[d.dist];
                if(center) map.flyTo(center, 12);
            }
        }

        function zoomToLocation() {
            const val = document.getElementById("neighborhoodSelect").value;
            if(!val) return;
            let d = JSON.parse(decodeURIComponent(val));
            
            if(d.lat) {
                selectUnit(d);
                map.flyTo([d.lat, d.lon], 16, {duration: 1.5});
            } else {
                fetchAndZoom(d);
            }
        }

        function selectUnit(d) {
            const style = styles[d.cat] || styles["mudurluk"];
            document.getElementById("infoTitle").innerText = d.name;
            const badge = document.getElementById("infoBadge");
            badge.innerText = d.app || style.label;
            badge.style.backgroundColor = style.color;

            document.getElementById("infoStatus").innerText = `${d.dist} / ${d.status}`;

            const stats = document.getElementById("infoStats");
            stats.innerHTML = '';
            
            if(d.is2B) {
                stats.innerHTML += `<div class="info-box"><span class="ib-val">${d.blk}</span><span class="ib-lbl">BLOK</span></div>`;
                stats.innerHTML += `<div class="info-box"><span class="ib-val">${d.ha}</span><span class="ib-lbl">HEKTAR</span></div>`;
            } else {
                stats.innerHTML += `<div class="info-box" style="grid-column:span 2"><span class="ib-val">${d.p}</span><span class="ib-lbl">PARSEL</span></div>`;
                if(d.ha > 0) stats.innerHTML += `<div class="info-box" style="grid-column:span 2; margin-top:5px"><span class="ib-val">${d.ha}</span><span class="ib-lbl">HEKTAR</span></div>`;
            }

            document.getElementById("info-card").style.display = "block";
            
            if(currentMarker) map.removeLayer(currentMarker);
            if(d.lat) {
                currentMarker = L.circleMarker([d.lat, d.lon], {
                    color: "#2c3e50", weight: 3, fillColor: style.color, fillOpacity: 1, radius: 8
                }).addTo(map).bindPopup(`ðŸ“ ${d.name}`).openPopup();
            }
        }

        // --- HELPERS ---
        function togglePanel() {
            document.getElementById("control-panel").classList.toggle("minimized");
        }
        document.getElementById("control-panel").addEventListener("click", function(e){
            if(this.classList.contains("minimized")) this.classList.remove("minimized");
        });

        function toggleBottomPanel() {
            document.getElementById("bottom-panel").classList.toggle("expanded");
        }

        async function fetchCoordinatesOnline(district, neighborhood) {
            const query = `${neighborhood}, ${district}, Mersin, TÃ¼rkiye`;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await res.json();
                if(data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch(e){}
            return null;
        }

        function openTKGM() { window.open("https://parselsorgu.tkgm.gov.tr/", "_blank"); }
        function openNav() {
            if(currentMarker) {
                const ll = currentMarker.getLatLng();
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${ll.lat},${ll.lng}`, "_blank");
            } else {
                alert("LÃ¼tfen Ã¶nce bir birim seÃ§in.");
            }
        }
        function resetView() {
            map.setView([36.7, 34.0], 9);
            document.getElementById("info-card").style.display = "none";
            if(currentMarker) map.removeLayer(currentMarker);
            
            document.getElementById("districtSelect").value = "all";
            document.getElementById("jobTypeSelect").value = "all";
            setMainFilter('all', document.querySelector('.filter-btn'));
        }

        fetchData();
    </script>
</body>
</html>
